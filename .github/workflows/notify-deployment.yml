name: Notify Deployment Status

on:
  deployment_status:

jobs:
  notify:
    runs-on: ubuntu-latest
    if: github.event.deployment_status.state == 'success' || github.event.deployment_status.state == 'failure'
    
    steps:
      - name: Send Telegram Notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          DEPLOYMENT_STATE: ${{ github.event.deployment_status.state }}
          DEPLOYMENT_URL: ${{ github.event.deployment_status.target_url }}
          REPO_NAME: ${{ github.repository }}
          COMMIT_SHA: ${{ github.sha }}
        run: |
          if [ "$DEPLOYMENT_STATE" == "success" ]; then
            EMOJI="✅"
            STATUS="deployed successfully"
          else
            EMOJI="❌"
            STATUS="failed to deploy"
          fi
          
          SHORT_SHA="${COMMIT_SHA:0:7}"
          TEXT="${EMOJI} Vercel Deployment - Repo: ${REPO_NAME} - Status: ${STATUS} - Commit: ${SHORT_SHA} - URL: ${DEPLOYMENT_URL}"
          
          # Send with response output for debugging
          RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=${TEXT}" \
            -d "disable_web_page_preview=true")
          
          echo "Telegram API Response: $RESPONSE"
